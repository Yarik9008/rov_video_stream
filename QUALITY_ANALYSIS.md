# Анализ качества передачи видеопотока

## Текущее состояние

### 1. Кодирование видео
- **Кодек**: H.264 (приоритет) или VP8 (fallback)
- **Битрейт по умолчанию**: 100 Mbps (100000 kbps)
- **Битрейт для тестового видео**: 200 Mbps (200000 kbps)
- **FPS**: 30 кадров/сек (настраивается)

### 2. Обработка кадров на сервере
- **Ресайз**: Используется `cv2.INTER_AREA` - хорошо для уменьшения, но не оптимально для сохранения качества
- **Формат кадров**: BGR24 (OpenCV)
- **Конвертация**: BGR → VideoFrame (PyAV)

### 3. Ограничения на клиенте
- **Throttling в client_qt.py**: Ограничение до 30 FPS для UI (строки 302-304, 385-389)
- **Масштабирование**: Используется `FastTransformation` в Qt (строка 541) - может снижать качество

### 4. Проблемы качества

#### Критические:
1. **Нет контроля CRF (Constant Rate Factor)** - aiortc не предоставляет прямой доступ к CRF
2. **Нет явной настройки профиля H.264** - может использоваться Baseline вместо High
3. **Throttling в клиенте** - ограничивает реальный FPS до 30, даже если сервер отправляет больше

#### Средние:
4. **Ресайз с INTER_AREA** - может терять детали при изменении размера
5. **Битрейт может быть недостаточным** для очень высокого разрешения (4K, 8K)
6. **FastTransformation в Qt** - быстрое, но не самое качественное масштабирование

#### Низкие:
7. **Нет адаптивного битрейта** - фиксированный битрейт может быть избыточным или недостаточным
8. **Нет контроля качества кодека** - используются настройки по умолчанию aiortc

## Рекомендации по оптимизации

### 1. Увеличить максимальный битрейт
- Для 1080p: минимум 20-25 Mbps
- Для 4K: минимум 50-100 Mbps
- Для максимального качества: 200+ Mbps (как сейчас для тестового видео)

### 2. Убрать throttling в клиенте
- Позволить клиенту получать все кадры от сервера
- Ограничение FPS должно быть только на сервере

### 3. Улучшить алгоритм ресайза
- Для уменьшения: `INTER_AREA` (текущий) - оптимально
- Для увеличения: `INTER_LANCZOS4` или `INTER_CUBIC` - лучшее качество
- Для сохранения размера: не делать ресайз вообще

### 4. Оптимизировать масштабирование в Qt
- Использовать `SmoothTransformation` вместо `FastTransformation` для лучшего качества

### 5. Добавить параметры качества
- `--quality` или `--crf` (если поддерживается)
- `--profile` для выбора профиля H.264
- Автоматический расчет битрейта на основе разрешения

### 6. Использовать исходное разрешение
- По умолчанию использовать разрешение источника без ресайза
- Ресайз только при явном указании `--width`/`--height`

## План реализации

1. ✅ Увеличить битрейт по умолчанию до 200 Mbps
2. ✅ Убрать throttling в client_qt.py
3. ✅ Улучшить алгоритм ресайза (выбор интерполяции в зависимости от операции)
4. ✅ Изменить масштабирование в Qt на SmoothTransformation
5. ✅ Добавить автоматический расчет битрейта на основе разрешения
6. ✅ Добавить параметр `--max-quality` для максимального качества

## Реализованные оптимизации

### 1. Увеличен битрейт по умолчанию
- **Было**: 100 Mbps (100000 kbps)
- **Стало**: 200 Mbps (200000 kbps)
- **Эффект**: Улучшение качества за счет меньшего сжатия

### 2. Улучшен алгоритм ресайза
- **Было**: Всегда `INTER_AREA`
- **Стало**: 
  - `INTER_AREA` для уменьшения (downscale) - оптимально
  - `INTER_LANCZOS4` для увеличения (upscale) - лучшее качество
- **Эффект**: Сохранение деталей при изменении размера

### 3. Убран throttling в клиенте
- **Было**: Ограничение до 30 FPS в `client_qt.py`
- **Стало**: Получение всех кадров от сервера
- **Эффект**: Реальный FPS соответствует серверному

### 4. Улучшено масштабирование в Qt
- **Было**: `FastTransformation` (быстро, но низкое качество)
- **Стало**: `SmoothTransformation` (высокое качество)
- **Эффект**: Лучшее качество отображения в UI

### 5. Добавлен автоматический расчет битрейта
- **Функция**: `calculate_optimal_bitrate(width, height, fps)`
- **Формула**: `битрейт = (ширина × высота × FPS × 0.12 бит/пиксель) / 1000`
- **Диапазон**: 5-500 Mbps
- **Эффект**: Оптимальный битрейт для любого разрешения

### 6. Добавлен режим максимального качества
- **Параметр**: `--max-quality`
- **Функции**:
  - Автоматический расчет битрейта
  - Использование исходного разрешения (без ресайза)
  - Минимальный FPS = 30
- **Эффект**: Максимальное качество без ручной настройки

### 7. Изменены значения по умолчанию
- **Разрешение**: `0` (исходное) вместо `1280x720`
- **Битрейт**: `200000` kbps вместо `100000`
- **Эффект**: По умолчанию используется максимальное качество

## Рекомендации по использованию

### Для максимального качества:

```bash
# Автоматический режим (рекомендуется)
python3 server.py --host 0.0.0.0 --max-quality --fps 60

# Ручная настройка для 4K
python3 server.py --host 0.0.0.0 --width 3840 --height 2160 --fps 60 --bitrate 500000
```

### Для баланса качества и производительности:

```bash
# 1080p, 30 FPS, 20 Mbps
python3 server.py --host 0.0.0.0 --width 1920 --height 1080 --fps 30 --bitrate 20000
```

### Для экономии ресурсов:

```bash
# 720p, 30 FPS, 5 Mbps
python3 server.py --host 0.0.0.0 --width 1280 --height 720 --fps 30 --bitrate 5000
```

## Ограничения aiortc

К сожалению, `aiortc` не предоставляет прямого доступа к:
- **CRF (Constant Rate Factor)** - контроль качества кодека
- **Профиль H.264** - выбор Baseline/Main/High Profile
- **Дополнительные параметры кодека** - настройки encoder'а

Эти ограничения могут влиять на качество, но реализованные оптимизации (высокий битрейт, оптимальный ресайз, отсутствие throttling) значительно улучшают качество передачи.

## Метрики качества

Для оценки качества рекомендуется:
1. **Визуальная оценка** - сравнение исходного и передаваемого видео
2. **PSNR (Peak Signal-to-Noise Ratio)** - объективная метрика качества
3. **SSIM (Structural Similarity Index)** - оценка структурного сходства
4. **Битрейт** - мониторинг реального битрейта передачи

## Дальнейшие улучшения

Возможные направления для дальнейшей оптимизации:
1. Интеграция с FFmpeg для прямого контроля CRF и профиля H.264
2. Адаптивный битрейт на основе сетевых условий
3. Поддержка H.265 (HEVC) для лучшего сжатия
4. Оптимизация буферизации для снижения задержки
